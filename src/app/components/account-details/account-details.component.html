<ng-container *ngIf="user$ | async as user; else noUser">
  <h1 mat-dialog-title>Account Details</h1>

  <div mat-dialog-content class="details-layout">
    <div class="display-details-layout">

      <div class="avatar-section">
        <div class="avatar-layout stack">
          <img [src]="user.photoURL || 'assets/logos/guest-account.webp'">
          <span class="premium-sash"
                [matTooltip]="'Thank you for supporting! ðŸ˜'"
                [@fade]
                *ngIf="user.isCustomer">
          Supporter
        </span>
        </div>
        <button class="open-edit-button"
                mat-icon-button
                (click)="isSettingsOpen = !isSettingsOpen">
          <mat-icon [svgIcon]="icons.Settings" class="text-mute"></mat-icon>
        </button>
      </div>

      <div class="user-details">
        <div>
          <cp-input-field class="input-field-contrast-text"
                          [formControl]="controlName"
                          label="Name"
                          (keyup.enter)="editDetails(user)"></cp-input-field>
          <div>{{user.email}}</div>
        </div>
      </div>

    </div>

    <div *ngIf="isSettingsOpen" [@expandX] class="edit-details-section">
      <mat-divider vertical></mat-divider>

      <cp-account-edit-details
        [isCustomer]="user.isCustomer"
        [validatingCustomer]="validatingCustomer$ | async"
        [uploadingImage]="uploadingImage$ | async"
        [editingDetails]="editingDetails$ | async"
        [deletingAccount]="deletingAccount$ | async"
        (validateAccount)="validateAccount(user)"
        (uploadImage)="uploadImage(user)"
        (editDetails)="editDetails(user)"
        (deleteAccount)="deleteAccount(user)"
      ></cp-account-edit-details>
    </div>
  </div>

  <div mat-dialog-actions>
    <button mat-button
            color="accent"
            (click)="actionSignOut()">
      Sign Out
    </button>

    <button color="primary"
            mat-stroked-button
            mat-dialog-close>
      Ok
    </button>
  </div>
</ng-container>

<ng-template #noUser>
  <h1 mat-dialog-title>Sign Up / Sign In</h1>

  <div mat-dialog-content class="sign-in-layout">
    <img class="app-image" src="assets/logos/ksp-visual-calculator-text-black.webp">

    <div class="promote-sign-in">
      <div class="reasons-header">
        <span>Why should I sign in?</span>
        <button mat-icon-button
                #buttonWhy
                (focus)="buttonWhy._elementRef.nativeElement.blur()"
                (click)="isPromoteOpen = !isPromoteOpen; $event.stopPropagation(); listenClickAway()">
          <mat-icon [svgIcon]="icons.ChevronDown" [@flipVertical]="isPromoteOpen"></mat-icon>
        </button>

        <div class="promote-reasons" [class.is-open]="isPromoteOpen" [@slideOutVertical]="isPromoteOpen">
          <div class="reasons-container">
            <div>Signed in accounts can access more features:</div>
            <ul>
              <li>Continue where you left off</li>
              <li>Manage multiple save games</li>
              <li>Load your save games from multiple devices</li>
              <li>Import/Export save games to share with friends</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="email-inputs-container">
      <div class="input-container">
        <mat-icon [svgIcon]="icons.Email"></mat-icon>
        <cp-input-field label="Email Address"
                        [formControl]="controlEmail"
                        [errors]="controlEmail.dirty && controlEmail.errors"></cp-input-field>
      </div>

      <div class="input-container">
        <mat-icon [svgIcon]="icons.Password"></mat-icon>
        <cp-input-field label="Password"
                        [type]="passwordVisible ? 'text' : 'password'"
                        [formControl]="controlPassword"
                        [errors]="controlPassword.dirty && controlPassword.errors"></cp-input-field>
        <button mat-icon-button
                (click)="passwordVisible = !passwordVisible">
          <mat-icon [svgIcon]="passwordVisible ? icons.Visible : icons.Invisible"></mat-icon>
        </button>
      </div>

      <button mat-button
              class="forgot-password link"
              [disabled]="controlEmail.invalid"
              (click)="forgotPassword()">
        Forgot password?
      </button>

      <div class="policy-layout">
        <cp-input-toggle label="I agree to the" [formControl]="controlPolicy"></cp-input-toggle>
        <a href="https://ksp-visual-calculator.blaarkies.com/policy" target="_blank">Privacy Policy</a>
      </div>
    </div>

    <div class="sign-in-button-email-container"
         [matTooltip]="'Please check the Privacy Policy to continue'"
         [matTooltipDisabled]="controlPolicy.valid">
      <button mat-stroked-button
              class="button-loader"
              (click)="signInWithEmailAddress()"
              [disabled]="controlEmail.invalid
                          || controlPassword.invalid
                          || controlPolicy.invalid
                          || (signingInWithEmail$ | async)"
              [matTooltip]="'New accounts are automatically created'">
        <mat-icon [svgIcon]="icons.Email"></mat-icon>
        <span>Sign in with email address</span>
      </button>
      <mat-progress-bar [@fade] *ngIf="signingInWithEmail$ | async" mode="indeterminate"></mat-progress-bar>
      <mat-error [@fade] *ngIf="emailSignInError$ | async as errorMessage">{{errorMessage}}</mat-error>
    </div>

    <mat-divider></mat-divider>

    <div class="sign-in-button-google-container"
         [matTooltip]="'Please check the Privacy Policy to continue'"
         [matTooltipDisabled]="controlPolicy.valid"
         matTooltipPosition="above">
      <button mat-stroked-button
              class="button-loader"
              [disabled]="controlPolicy.invalid || (signingInWithGoogle$ | async)"
              (click)="signInWithGoogle()">
        <img class="google-g-logo" src="assets/logos/google-g.svg" />
        <span>Sign in with Google</span>
      </button>
      <mat-progress-bar [@fade] *ngIf="signingInWithGoogle$ | async" mode="indeterminate"></mat-progress-bar>
    </div>

    <mat-divider></mat-divider>
  </div>

  <div mat-dialog-actions>
    <span class="text-mute description">Or sign in later, using the profile icon in the top-right corner</span>
    <button mat-stroked-button
            mat-dialog-close
            color="primary">
      Later
    </button>
  </div>
</ng-template>
